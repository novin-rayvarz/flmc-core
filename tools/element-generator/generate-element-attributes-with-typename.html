<html>

<body>
    <h5>element type:</h5>
    <input id="input_element_type" name="input" />
    <h3>Types names ( 1 line = 1 type name ):</h3>
    <textarea id="inputTypes" multiple="true" style="width: 300px;height:300px"></textarea>
    <br />
    <button onclick="generate()">generate</button>
    <br />

    <div>
            <h3>Output Element:</h3>
            <textarea id="output" multiple="true" style="width: 600px;height:400px"></textarea>
            <h3>Output View:</h3>
            <textarea id="outputView" multiple="true" style="width: 600px;height:400px"></textarea>
    </div>


    <script>

        function jsLcfirst(string) {
            return string.charAt(0).toLowerCase() + string.slice(1);
        }

        function generateReactUseState(typename) {
            let lowercaseTypeName = jsLcfirst(typename);
            return `const [${lowercaseTypeName}, set${typename}] = React.useState();`;
        }

        function generateSubscribe(typename) {
            let lowercaseTypeName = jsLcfirst(typename);
            return `
let ${lowercaseTypeName}Sub = element.${lowercaseTypeName}Container.subscribe({
    next: v => set${typename}(v)
});
`
        }

        function generateUnSubscribe(typename) {
            let lowercaseTypeName = jsLcfirst(typename);
            return `${lowercaseTypeName}Sub.unsubscribe();`;
        }

        function generateReactStatesWithTypename(typenames) {
            let useStates = typenames.map(typename => generateReactUseState(typename));
            let subscribes = typenames.map(typename => generateSubscribe(typename));
            let unsubscribes = typenames.map(typename => generateUnSubscribe(typename));

            return `
${useStates.join("\n")}

React.useEffect(() => {

    ${subscribes.join("\n")}

    return () => {
        ${unsubscribes.join("\n")}
    }
})
`

        }

        function generateAttributeForTypeName(typename, elementType) {
            let lowercaseTypeName = jsLcfirst(typename);
            let containerName = `${lowercaseTypeName}Container`;
            let oFunctiuonName = `${lowercaseTypeName}O`;
            let rFunctiuonName = `${lowercaseTypeName}R`;
            return `
${containerName} = new BehaviorSubject<${typename}>([]);

private ${rFunctiuonName}(value: ${typename}): ${elementType} {
    this.${containerName}.next(value);
    return this;
}

private ${oFunctiuonName}(value: Observable<${typename}>): ${elementType} {
    value.subscribe({
        next: v => this.${containerName}.next(v),
    });
    return this;
}

${lowercaseTypeName}(value: Observable<${typename}> | ${typename}): ${elementType} {
    if (isObservable(value)) this.${oFunctiuonName}(value);
    else this.${rFunctiuonName}(value);
    return this;
}
`
        }

        let elementTypeDOM = document.getElementById("input_element_type");
        let TypeNamesDOM = document.getElementById("inputTypes");
        let outputDOM = document.getElementById("output");
        let outputViewDOM = document.getElementById("outputView");

        function generate() {

            let codeBlocks = [];

            for (let line of TypeNamesDOM.value.trim().split("\n"))
                codeBlocks.push(generateAttributeForTypeName(line, elementTypeDOM.value.trim()));

            outputDOM.value = codeBlocks.join("\n");
            outputViewDOM.value = generateReactStatesWithTypename(TypeNamesDOM.value.trim().split("\n"));

        }


    </script>

    <script src="./parser.js"></script>
    <script src="./element-generator.js"></script>
    <script src="./view-generator.js"></script>

</body>

</html>